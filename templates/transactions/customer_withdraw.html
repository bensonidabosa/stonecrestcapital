{% extends "../account/base/base.html" %}
{% load humanize %}
{% block title %}User Withdraw{% endblock %}

{% block content %}
<style>
    .card {
        border-left: 4px solid #041757;
        /* Bitcoin orange hint */
    }
</style>

<div class="container-fluid mb-4">
    <div class="row">
        <div class="col-lg-8">
            <h4 class="mb-2">Withdraw Funds</h4>
            <p class="text-muted mb-0">
                Submit a withdrawal request to transfer funds from your account.
                Withdrawals are processed after review and may take 1-3 business days depending on the selected method.
            </p>
        </div>
    </div>
</div>
<hr>
<div class="row mb-4">

    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <small class="text-muted">Available Balance</small>
                <h5 class="mb-0">${{ portfolio.cash_balance|floatformat:2|intcomma }}</h5>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <small class="text-muted">Locked / Invested</small>
                <h5 class="mb-0">${{ portfolio.total_holding_value|floatformat:2|intcomma }}</h5>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <small class="text-muted">Pending Withdrawals</small>
                <h5 class="mb-0">${{ pending_withdraw_sum|floatformat:2|intcomma }}</h5>
            </div>
        </div>
    </div>

</div>


<div class="row">
    <div class="col-md-8">
        <div class="card mb-5">
            <div class="card-header">
                Request Withdrawal
            </div>
            {% include "../notification/messages.html" %}
            {% for error in form.non_field_errors %}
            <div class="alert alert-danger">
                {{ error }}
            </div>
            {% endfor %}

            <div class="card-body">
                <form method="post" class="pinner-form" novalidate>
                    {% csrf_token %}

                    <div class="row g-3">

                        <!-- Deposit Type -->
                        <div class="col-md-6">
                            <label class="form-label">Withdrawal Method</label>
                            {{ form.payment_method }}

                            {% for error in form.payment_method.errors %}
                            <div class="invalid-feedback d-block">
                                {{ error }}
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Amount -->
                        <div class="col-md-6">
                            <label class="form-label">Amount</label>
                            {{ form.amount }}

                            {% for error in form.amount.errors %}
                            <div class="invalid-feedback d-block">
                                {{ error }}
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Wire Transfer Fields -->
                        <div id="wire_fields" style="display:none;">
                            <div class="col-md-6">
                                <label class="form-label">Destination Bank</label>
                                {{ form.destination_bank }}
                                {% for error in form.destination_bank.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ error }}
                                </div>
                                {% endfor %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Account Number</label>
                                {{ form.account_number }}

                                {% for error in form.account_number.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ error }}
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Crypto Fields -->
                        <div id="crypto_fields" style="display:none;">
                            <div class="col-md-6">
                                <label class="form-label">Coin Type</label>
                                {{ form.coin_type }}
                                {% for error in form.coin_type.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ error }}
                                </div>
                                {% endfor %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Wallet ID</label>
                                {{ form.wallet_id }}
                                {% for error in form.wallet_id.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ error }}
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Reference / Note -->
                        <div class="col-md-12">
                            <label class="form-label">Note (Optional)</label>
                            {{ form.note }}

                            {% for error in form.note.errors %}
                            <div class="invalid-feedback d-block">
                                {{ error }}
                            </div>
                            {% endfor %}
                        </div>
                        <!-- Submit -->
                        <div class="col-12 mt-3">
                            <button type="submit" class="btn btn-primary w-100 btn-sm fw-bold"
                                data-spinner-text="Submitting..." data-spinner-class="btn-secondary w-100">
                                Submit Withdrawal Request
                            </button>
                        </div>

                    </div>

                </form>

                <p class="small text-muted mt-3 mb-0">
                    Withdrawal requests are reviewed for security and compliance.
                    Funds involved in active strategies or copy trading may not be eligible.
                </p>

            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        Withdrawal History
    </div>

    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">

            <thead class="table-light">
                <tr>
                    <th>Date</th>
                    <th>Type</th>
                    <th>Method</th>
                    <th>Amount</th>
                    <th>Status</th>
                </tr>
            </thead>

            <tbody>
                {% for t in transactions %}
                <tr>
                    <td>{{ t.timestamp|date:"Y-m-d" }}</td>
                    <td>
                        {% if t.transaction_type == "DEPOSIT" %}
                        <span class="badge bg-success">Deposit</span>
                        {% elif t.transaction_type == "WITHDRAW" %}
                        <span class="badge bg-danger">Withdrawal</span>
                        {% else %}
                        <span class="badge bg-warning">
                            {{ t.get_transaction_type_display }}
                        </span>
                        {% endif %}
                    </td>
                    <td>{{ t.payment_method }}</td>
                    <td>${{ t.amount|floatformat:2|intcomma }}</td>
                    <td>
                        {% if t.status == "PENDING" %}
                        <span class="badge bg-warning-subtle text-warning">
                            Pending
                        </span>
                        {% elif t.status == "SUCCESSFUL" %}
                        <span class="badge bg-success-subtle text-success">
                            Successful
                        </span>
                        {% else %}
                        <span class="badge bg-danger-subtle text-danger">
                            Failed
                        </span>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center">No transactions yet.</td>
                </tr>
                {% endfor %}
            </tbody>

        </table>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const methodField = document.querySelector("select[name='payment_method']");
        const wireFields = document.getElementById("wire_fields");
        const cryptoFields = document.getElementById("crypto_fields");

        function toggleFields() {
            const method = methodField.value;

            if (method === "WIRE") {
                wireFields.style.display = "flex";
                cryptoFields.style.display = "none";
            } else if (method === "CRYPTO") {
                wireFields.style.display = "none";
                cryptoFields.style.display = "flex";
            } else {
                wireFields.style.display = "none";
                cryptoFields.style.display = "none";
            }
        }

        methodField.addEventListener("change", toggleFields);
        toggleFields(); // initialize on page load
    });
</script>

{% endblock %}